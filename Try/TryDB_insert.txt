create domain dm_cod_role as char(1) not null check(value = 'P' or value = 'D' or value = 'C' or value = 'A');

create domain dm_piede as char(1) NOT null check(value = 'D' or value = 'S' or value = 'A');

create domain dm_string as text not null check(value ~ '^[A-Za-z](?!.*(''''|--|''-|-''|\\s\\s|\\s-|-\\s|''\\s''|\\s''\\s|\\s[A-Za-z]\\s|''[A-Za-z]+''|-[A-Za-z]-))[A-Za-z\s''-]+[A-Za-z]$');

create table feature
(
	id_feature SERIAL NOT null,
	nome dm_string NOT null
);
alter sequence feature_id_feature_seq restart with 1;
alter table feature add constraint pk_feauture PRIMARY KEY (id_feature);
ALTER TABLE  feature ADD CONSTRAINT uq_nome UNIQUE (nome);

CREATE TABLE Ruolo
(
	codice dm_cod_role NOT NULL,
	descrizione dm_string NOT NULL
);

ALTER TABLE Ruolo ADD CONSTRAINT pk_ruolo PRIMARY KEY (codice);
ALTER TABLE Ruolo ADD CONSTRAINT uq_descrizione UNIQUE (descrizione);


CREATE TABLE Calciatore
(
	id_calciatore SERIAL NOT NULL,
	nome dm_string NOT NULL,
	cognome dm_string NOT NULL,
	dataNascita DATE NOT NULL,
	piede dm_piede NOT NULL,
	dataRitiro DATE
);

ALTER SEQUENCE Calciatore_id_calciatore_seq RESTART WITH 1;
ALTER TABLE Calciatore ADD CONSTRAINT pk_Calciatore PRIMARY KEY (id_calciatore);
ALTER TABLE Calciatore ADD CONSTRAINT uq_Calciatore UNIQUE (nome, cognome, dataNascita);


create table Squadra
(
	id_squadra SERIAL NOT NULL,
	nome dm_string NOT NULL,
	nazionalita dm_string NOT NULL
);

ALTER SEQUENCE Squadra_id_squadra_seq RESTART WITH 1;
ALTER TABLE Squadra ADD CONSTRAINT pk_squadra PRIMARY KEY (id_squadra);
ALTER TABLE Squadra ADD CONSTRAINT uq_squadra UNIQUE (nome, nazionalita);



CREATE TABLE Feature_Calciatore
(
	id_feature INTEGER NOT NULL,
	id_calciatore INTEGER NOT NULL
);

ALTER TABLE Feature_Calciatore ADD CONSTRAINT pk_feature_calciatore PRIMARY KEY (id_feature, id_calciatore);
ALTER TABLE Feature_Calciatore ADD CONSTRAINT fk_feature_calciatore_feature FOREIGN KEY (id_feature) REFERENCES feature(id_feature)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE Feature_Calciatore ADD CONSTRAINT fk_feature_calciatore_calciatore FOREIGN KEY (id_calciatore) REFERENCES Calciatore(id_calciatore)
ON DELETE CASCADE
ON UPDATE CASCADE;


CREATE TABLE Ruolo_Calciatore
(
	codice dm_cod_role NOT NULL,
	id_calciatore INTEGER NOT NULL
);

ALTER TABLE Ruolo_Calciatore ADD CONSTRAINT pk_ruolo_calciatore PRIMARY KEY (codice, id_calciatore);
ALTER TABLE Ruolo_Calciatore ADD CONSTRAINT fk_ruolo_calciatore_ruolo FOREIGN KEY (codice) REFERENCES Ruolo(codice)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE Ruolo_Calciatore ADD CONSTRAINT fk_ruolo_calciatore_calciatore FOREIGN KEY (id_calciatore) REFERENCES Calciatore(id_calciatore)
ON DELETE CASCADE
ON UPDATE CASCADE;


CREATE TABLE Trofeo
(
	id_trofeo SERIAL NOT NULL,
	nome dm_string NOT NULL,
	tipo BOOLEAN NOT NULL
);

ALTER SEQUENCE Trofeo_id_trofeo_seq RESTART WITH 1;
ALTER TABLE Trofeo ADD CONSTRAINT pk_trofeo PRIMARY KEY (id_trofeo);
ALTER TABLE Trofeo ADD CONSTRAINT uq_trofeo UNIQUE (nome);

CREATE DOMAIN dm_unsigned AS INTEGER NOT NULL CHECK ( VALUE >= 0);

CREATE TABLE Militanza
(
	id_militanza SERIAL NOT NULL,
	id_calciatore INTEGER NOT NULL,
	id_squadra INTEGER NOT NULL,
	data_inizio DATE NOT NULL,
	data_fine DATE NOT NULL,
	presenze dm_unsigned NOT NULL,
	goal dm_unsigned NOT NULL
);

ALTER SEQUENCE Militanza_id_militanza_seq RESTART WITH 1;
ALTER TABLE Militanza ADD CONSTRAINT pk_militanza PRIMARY KEY (id_militanza);
ALTER TABLE Militanza ADD CONSTRAINT uq_militanza UNIQUE ( id_calciatore, id_squadra, data_inizio, data_fine);
ALTER TABLE Militanza ADD CONSTRAINT fk_Militanza_Calciatore FOREIGN KEY (id_calciatore) REFERENCES Calciatore(id_calciatore)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE Militanza ADD CONSTRAINT fk_Militanza_Squadra FOREIGN KEY (id_squadra) REFERENCES Squadra(id_squadra)
ON DELETE NO ACTION
ON UPDATE CASCADE;


CREATE TABLE Trofeo_Calciatore
(
	id_trofeo_calciatore SERIAL NOT NULL,
	id_trofeo INTEGER NOT NULL,
	id_calciatore INTEGER NOT NULL,
	data_assegnazione DATE NOT NULL
);

ALTER SEQUENCE Trofeo_Calciatore_id_trofeo_calciatore_seq RESTART WITH 1;
ALTER TABLE Trofeo_Calciatore ADD CONSTRAINT pk_trofeo_calciatore PRIMARY KEY (id_trofeo_calciatore);
ALTER TABLE Trofeo_Calciatore ADD CONSTRAINT uq_trofeo_calciatore UNIQUE (id_trofeo, id_calciatore, data_assegnazione);
ALTER TABLE Trofeo_Calciatore ADD CONSTRAINT fk_trofeo_calciatore_trofeo FOREIGN KEY (id_trofeo) REFERENCES Trofeo(id_trofeo);
ON DELETE NO ACTION
ON UPDATE CASCADE;
ALTER TABLE Trofeo_Calciatore ADD CONSTRAINT fk_trofeo_calciatore_calciatore FOREIGN KEY (id_calciatore) REFERENCES Calciatore(id_calciatore);
ON DELETE CASCADE
ON UPDATE CASCADE;


CREATE TABLE Trofeo_Squadra
(
	id_trofeo_squadra SERIAL NOT NULL,
	id_trofeo INTEGER NOT NULL,
	id_squadra INTEGER NOT NULL,
	data_assegnazione DATE NOT NULL
);

ALTER SEQUENCE Trofeo_Squadra_id_trofeo_squadra_seq RESTART WITH 1;
ALTER TABLE Trofeo_Squadra ADD CONSTRAINT pk_trofeo_squadra PRIMARY KEY (id_trofeo_squadra);
ALTER TABLE Trofeo_Squadra ADD CONSTRAINT uq_trofeo_squadra UNIQUE (id_trofeo, id_squadra, data_assegnazione);
ALTER TABLE Trofeo_Squadra ADD CONSTRAINT fk_trofeo_squadra_trofeo FOREIGN KEY (id_trofeo) REFERENCES Trofeo(id_trofeo)
ON DELETE NO ACTION
ON UPDATE CASCADE;
ALTER TABLE Trofeo_Squadra ADD CONSTRAINT fk_trofeo_squadra_squadra FOREIGN KEY (id_squadra) REFERENCES Squadra(id_squadra)
ON DELETE CASCADE
ON UPDATE CASCADE;

CREATE TABLE Militanza_Portiere
(
	id_militanza INTEGER NOT NULL,
	goal_subiti dm_unsigned NOT NULL
);

ALTER TABLE Militanza_Portiere ADD CONSTRAINT pk_Militanza_Portiere PRIMARY KEY(id_militanza);
ALTER TABLE Militanza_Portiere ADD CONSTRAINT fk_Militanza_Portiere_Militanza FOREIGN KEY (id_militanza)
REFERENCES Militanza(id_militanza)
ON DELETE CASCADE
ON UPDATE CASCADE;



INSERT INTO Feature (nome) VALUES
  ('Passing'),
  ('Shooting'),
  ('Dribbling'),
  ('Defending');

INSERT INTO Ruolo (codice, descrizione) VALUES
  ('P', 'Goalkeeper'),
  ('D', 'Defender'),
  ('C', 'Midfielder'),
  ('A', 'Forward');

INSERT INTO Calciatore (nome, cognome, dataNascita, piede, dataRitiro) VALUES
  ('Lionel', 'Messi', '1987-06-24', 'S', NULL),
  ('Cristiano', 'Ronaldo', '1985-02-05', 'D', NULL),
  ('Virgil', 'van Dijk', '1991-07-08', 'D', NULL);

INSERT INTO Squadra (nome, nazionalita) VALUES
  ('FC Barcelona', 'Spain'),
  ('Juventus FC', 'Italy'),
  ('Liverpool FC', 'England');

INSERT INTO Feature_Calciatore (id_feature, id_calciatore) VALUES
  (1, 1), -- Messi - Passing
  (2, 1), -- Messi - Shooting
  (3, 1), -- Messi - Dribbling
  (4, 3); -- Van Dijk - Defending

INSERT INTO Ruolo_Calciatore (codice, id_calciatore) VALUES
  ('A', 1), -- Messi - Forward
  ('D', 3); -- Van Dijk - Defender

INSERT INTO Trofeo (nome, tipo) VALUES
  ('Champions League', TRUE),
  ('Golden Boot', FALSE);

INSERT INTO Militanza (id_calciatore, id_squadra, data_inizio, data_fine, presenze, goal) VALUES
  (1, 1, '2003-01-01', '2021-08-05', 778, 672), -- Messi at Barcelona
  (2, 2, '2018-07-10', '2021-08-30', 133, 101), -- Ronaldo at Juventus
  (3, 3, '2018-01-01', '2021-08-30', 130, 8);   -- Van Dijk at Liverpool

INSERT INTO Trofeo_Calciatore (id_trofeo, id_calciatore, data_assegnazione) VALUES
  (1, 1, '2015-06-06'), -- Messi - Champions League
  (2, 2, '2018-05-20'); -- Ronaldo - Golden Boot

INSERT INTO Trofeo_Squadra (id_trofeo, id_squadra, data_assegnazione) VALUES
  (1, 1, '2015-06-06'), -- Barcelona - Champions League
  (2, 2, '2018-05-20'); -- Juventus - Golden Boot
